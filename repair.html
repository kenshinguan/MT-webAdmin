<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="UTF-8">
		<title>返修单</title>
		<link href="css/zui.css" rel="stylesheet" />
		<link href="css/chosen.css" rel="stylesheet" />
		<link href="lib/datatable/zui.datatable.min.css" rel="stylesheet" />
		<link href="css/common.css" rel="stylesheet" />
		<link href="css/page.css" rel="stylesheet" />
		<script src="js/jquery-1.9.1.min.js"></script>
		<script src="js/jquery.zclip.js"></script>
		<script src="js/zui.js"></script>
		<script src="js/chosen.js"></script>
		<script src="lib/datatable/zui.datatable.min.js"></script>
		<script src="js/common.js"></script>
	</head>
	<style type="text/css">
		.addModal form input[type=text],
		.addModal form select,
		.addModal form textarea {
			line-height: 30px;
			border: 1px solid #ccc;
			border-radius: 5px;
			text-indent: 5px;
			min-width: 200px;
			min-height: 30px;
			background: #fff;
			color: #333;
			width: 200px;
		}
		
		.addModal input[type=text][readonly=readonly] {
			background: #fff;
		}
		
		.page_explain {
			margin-top: 20px;
			margin-bottom: 20px;
		}
		
		.pos {
			position: relative;
		}
	</style>

	<body class="minwidth1080">
		<div class="head">
			<div class="modal fade addModal" id="detailModal">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">关闭</span></button>
							<h4 class="modal-title">详情</h4>
						</div>
						<div class="modal-body">
							<table class="table table-striped table-bordered cardTable table-datatable datatable">
								<thead>
									<tr>
										<th>序号</th>
										<th>MID</th>
										<th>描述</th>
									</tr>
								</thead>
								<tbody>

								</tbody>
							</table>
						</div>
					</div>
				</div>
			</div>

			<ol class="breadcrumb">
				<li>
					<a href="your/url/"><i class="icon icon-home"></i>当前位置</a>
				</li>
				<li>
					<a href="your/url/">查询</a>
				</li>
				<li class="active">返修单</li>
			</ol>
			<div class="row operationbar">
				<div class="col-md-7">
				</div>
				<div class="col-md-5">
					<div class="input-group">
						<span class="input-group-addon"><i class="icon-search"></i></span>
						<input type="text" class="form-control" id="searchKey">
						<span class="input-group-addon input-remove"><i class="icon-remove-circle"></i></span>
						<span class="input-group-btn">
                        <button class="btn btn-default" type="button">搜索</button>
                    </span>
					</div>
					<div class="search-group hidden" id='searchlist'>
						<div class="list-group">
							<a href="#" class="list-group-item active" data-type="trackingNumber">
								在快递单号中查找：
								<span></span>
							</a>
							<a href="#" class="list-group-item" data-type="recipient">
								在收件人中查找：
								<span></span>
							</a>
							<a href="#" class="list-group-item" data-type="mid">
								在mid中查找：
								<span></span>
							</a>
							<a href="#" class="list-group-item" data-type="describer">
								在描述中查找：
								<span></span>
							</a>
						</div>
					</div>
				</div>
			</div>

			<div class="searchbar">
				<label id="copy">标签</label>
				<select class="chosen-select form-control" id="labelType" multiple="">
				</select>
				<label class="ml10">状态</label>
				<select class="form-control" id="repairType">
					<option value="">全部</option>
					<option value="有效">有效</option>
					<option value="关闭">关闭</option>
					<option value="删除">删除</option>
				</select>
			</div>
		</div>
		<div class="main">
			<table class="table table-striped table-bordered cardTable table-datatable datatable table-hover">
				<thead>
					<tr>
						<th style="width: 7%">序号</th>
						<th style="width: 15%">快递单号</th>
						<th style="width: 10%">收件人</th>
						<th style="width: 10%">状态</th>
						<th style="width: 10%">标签</th>
						<th style="width: 15%">项目</th>
						<th style="width: 20%">设备</th>
						<th style="width: 10%">详情</th>

					</tr>
				</thead>
				<tbody>
				</tbody>

			</table>
		</div>
		<div class="footer row">
			<div class="col-md-8 leftpage">
				<span class="ml10">总计：<span class="total">0</span>条</span>
				<label class="ml40">显示</label>
				<select class="form-control" id="pageSize">
					<!--<option value="10">10</option>
					<option value="20">20</option>-->
					<option value="50">50</option>
					<option value="100">100</option>
				</select>
				<label>行</label>
			</div>
			<div class="text-right col-md-4">
				<ul class="pager ">

				</ul>
				<input type="text" id="numtxt" />
				<input type="submit" value="跳转" class="btn" id="gotopage" />
			</div>
		</div>
		<div class="page_explain">
			<h5 class="ml10" style="color: #FF0000;">*查询快递信息需要浏览器安装Flash插件，并且启用</h5>
			<h5 class="ml10" style="color: #FF0000;">*点击快递单号后，通过Ctrl+v粘贴至搜索框进行查询</h5>
		</div>
	</body>

</html>
<script>
	//初始化数据表
	var page = 1,
		pageSize = 50,
		pagecount = 0;

	$(function() {
		$('#searchlist .list-group a').click(function() {
			$('#searchlist .list-group a.active').removeClass('active');
			$(this).addClass('active');
		});
		$('.input-group-btn .btn-default').click(function() {
			page = 1;
			getdata(page);
		});

		searchkey();

		getTags('联系人');

		getdata(page);

	});

	//页面大小选择
	$("#pageSize").bind("change", function() {
		if($(this).val() == 0) {
			return;
		} else {
			pageSize = $(this).val();
			page = 1;
			getdata(page);
		}
	});

	//描述详情
	function checkDetails(detailsData) {
		var detailsStr = '';
		if(detailsData.length > 0) {
			for(var i = 0; i < detailsData.length; i++) {
				detailsStr += ' <tr><td>' + (i + 1) + '</td><td>' + detailsData[i].mid + '</td><td>' + detailsData[i].describer + '</td></tr>';
			}

		}

		$('.head .table tbody').html(detailsStr);
		$("#detailModal").modal("show");
	}

	function getdata(page) {
		var labels = '';
		if($('#labelType').val() != null) {
			labels = JSON.stringify($('#labelType').val());
		}
		var status = $('#repairType').val();

		var trackingNumber = '';
		var recipient = '';
		var mid = '';
		var describer = '';
		var type = $('#searchlist .list-group-item.active').attr('data-type');
		if(type == 'trackingNumber') {
			trackingNumber = $('#searchKey').val();
		} else if(type == 'recipient') {
			recipient = $('#searchKey').val();
		} else if(type == 'mid') {
			mid = $('#searchKey').val();
		} else if(type == 'describer') {
			describer = $('#searchKey').val();
		}

		var param = {
			"describer": describer,
			"labels": labels,
			"mid": mid,
			"name": recipient,
			"status": status,
			"trackingNumber": trackingNumber,
			"page": page,
			"pageSize": pageSize,
			"sessionKey": session.sessionKey,
			"sessionId": session.sessionId,
			"operater": operater,
			"clientType": 'admin'
		}
		console.log(JSON.stringify(param));

		$.ajax({
			type: 'post',
			url: service + "repair_order/find_by_key",
			dataType: "json",
			data: param,
			success: function(data) {
				console.log(JSON.stringify(data));
				if(data.ret == 'ok') {
					var result = data.item;
					pagecount = Math.ceil(data.totalSize / pageSize);

					_TOTAL = pagecount;
					_NUM = data.page;
					pager(_NUM, _TOTAL);
					var str = "";
					if(result) {
						for(var i = 0; i < result.length; i++) {
							if(result[i].labels) {
								var labels_str = '';
								for(var j = 0; j < result[i].labels.length; j++) {
									if(result[i].labels[j]) {
										labels_str += '<div>' + result[i].labels[j].labelName + '</div>';
									}
								}
							}
							if(result[i].repairOrderDetails) {
								var repairOrderDetails_str = '';
								for(var k = 0; k < result[i].repairOrderDetails.length; k++) {
									repairOrderDetails_str += '<div>' + result[i].repairOrderDetails[k].mid + '</div>';
								}
							}

							str += ' <tr data-id="' + result[i].id + '"> <td>' + ((page - 1) * pageSize + (i + 1)) + '</td><td><div class="pos"><a href="javascript:;" class="openKuaidi">' + result[i].trackingNumber + '</a></div></td><td>' + result[i].moduleContact.name + '</td><td>' + result[i].status + '</td><td>' + labels_str + '</td><td>' + result[i].moduleProject.projectName + '</td><td>' + repairOrderDetails_str + '</td>' +
								' <td> <a href="javascript:;" onclick=\'checkDetails(' + JSON.stringify(result[i].repairOrderDetails) + ')\'>查看</a> </td></tr>';
						}
						$('.main table tbody').html(str);
						$(".total").text(data.totalSize);
					} else {
						$('.main table tbody').html(str);
						$(".total").text(data.totalSize);
					}

					$(".openKuaidi").zclip({
						path: 'js/ZeroClipboard.swf',
						copy: function() {
							return $(this).text();
						},
						afterCopy: function() {
							window.open("https://www.kuaidi100.com/");
						}
					});

				}

			},
			error: function() {
				alert("发生错误");
			}
		});
	}
</script>