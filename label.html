<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="UTF-8">
		<title>标签</title>
		<link href="css/zui.css" rel="stylesheet" />
		<link href="css/chosen.css" rel="stylesheet" />
		<link href="css/common.css" rel="stylesheet" />
		<link href="css/page.css" rel="stylesheet" />
		<script src="js/jquery-1.9.1.min.js"></script>
		<script src="js/zui.js"></script>
		<script src="js/chosen.js"></script>
		<script src="js/common.js"></script>
		<style type="text/css">
			.chosen-container {
				width: 200px !important;
			}
		</style>
	</head>

	<body class="minwidth1080">
		<div class="head">
			<div class="modal fade" id="confirmModal">
				<div class="modal-dialog  modal-sm">
					<div class="modal-content">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">关闭</span></button>
							<h4 class="modal-title">确定</h4>
						</div>
						<div class="modal-body">
							<input type="hidden" id="confirmDelId" />
							<input type="hidden" name="deltabId" id="deltabId" value="" />
							<p>你确定删除吗？</p>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-primary" onclick="confirmDelBtn()">确定</button>
							<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
						</div>
					</div>
				</div>
			</div>
			<div class="modal fade addModal" id="addDoorModal">
				<div class="modal-dialog ">
					<div class="modal-content">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">关闭</span></button>
							<h4 class="modal-title">新建</h4>
						</div>
						<div class="modal-body">
							<form method="" action="" class="modal-form">
								<input type="hidden" value id="userID" />

								<p>
									<label for="">上级标签</label>
									<select id="depart">
									</select>

								</p>
								<p>
									<label for="">名称</label>
									<input type="text" id="labelName">
								</p>
								<p id="changecolorbox">
									<label for="">颜色</label>
									<span class="colortag">
                                    <span style="background: #cdcdcd;"></span>
									<span style="background: #ff66ff;"></span>
									<span style="background: #ff9998;"></span>
									<span style="background: #ff9932;"></span>
									<span style="background: #ffff66;"></span>
									<span style="background: #67ceff;"></span>
									<span style="background: #6666ff;"></span>
									</span>
								</p>

							</form>
						</div>
						<div class="modal-footer text-center">
							<button type="button" class="btn btn-primary" id="addlabelBtn">确定</button>
							<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
						</div>
					</div>
				</div>
			</div>

			<div class="modal fade addModal" id="editmodal">
				<div class="modal-dialog ">
					<div class="modal-content">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">关闭</span></button>
							<h4 class="modal-title">编辑</h4>
						</div>
						<div class="modal-body">
							<form method="" action="" class="modal-form">
								<input type="hidden" value id="editId" />
								<input type="hidden" name="tabId" id="tabId" value="" />
								<p>
									<label for="">名称</label>
									<input type="text" id="editName">
								</p>
								<p id="changecolormodal">
									<label for="">颜色</label>
									<span class="colortag">
                                    <span style="background: #cdcdcd;"></span>
									<span style="background: #ff66ff;"></span>
									<span style="background: #ff9998;"></span>
									<span style="background: #ff9932;"></span>
									<span style="background: #ffff66;"></span>
									<span style="background: #67ceff;"></span>
									<span style="background: #6666ff;"></span>
									</span>
								</p>

							</form>
						</div>
						<div class="modal-footer text-center">
							<button type="button" class="btn btn-primary" onclick="confirmEditBtn()">确定</button>
							<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
						</div>
					</div>
				</div>
			</div>
			<ol class="breadcrumb">
				<li>
					<a href="your/url/"><i class="icon icon-home"></i>当前位置</a>
				</li>
				<li>
					<a href="your/url/">设置</a>
				</li>
				<li class="active">标签</li>
			</ol>
			<div class="row operationbar">
				<div class="col-md-7">
					<button class="btn btn-primary" type="button" id='js-addGroup'>新增</button>
					<button class="btn" type="button" onclick="delItem()">删除</button>
				</div>
				<div class="col-md-5">
					<div class="input-group">
						<span class="input-group-addon"><i class="icon-search"></i></span>
						<input type="text" class="form-control">

						<span class="input-group-btn">
                        <button class="btn btn-default" type="button">搜索</button>
                    </span>
					</div>

				</div>
			</div>

		</div>
		<div class="main">
			<div class='cols-wrap mt20'>
				<div class="cols-main" style="width: 100%;">
					<table class="table table-striped table-bordered cardTable table-datatable table-hover" style="display: none">
					</table>
				</div>
				<div class="cols-aside submenu">
					<div class="hd">标签选项</div>
					<ul class="bd ">
						</li>

					</ul>
				</div>
			</div>

		</div>

	</body>

</html>
<script type="text/javascript" src="js/template.js"></script>
<script>
	var select = [];

	$(function() {
			$('.submenu ').on("click", ".bd> li>a i", function() {
				if($(this).parents('li').hasClass('open')) {
					$(this).parents('li').removeClass('open');
				} else {
					$('.submenu .bd> li.open').removeClass('open')
					$(this).parents('li').addClass('open');
				}
			})
			$("#changecolormodal,#changecolorbox").on('click', '.colortag span', function() {
				$(this).toggleClass("active").siblings("span.active").removeClass("active");
			})
			getdata();

			$(".cols-main").on('click', '.editBtn', function() {
				var $me = $(this).parents("tr");
				$("#editName").val($me.find("td").eq(2).text());
				$("#editId").val($me.attr("data-id"));
				$('#tabId').val($me.parents('table').attr('id'));
				$("#editmodal").modal("show");
			})
			$(".cols-main").on('click', '.delBtn', function() {
				var $me = $(this).parents("tr");
				$("#confirmDelId").val($me.attr("data-id"));
				$('#deltabId').val($me.parents('table').attr('id'));
				$("#confirmModal").modal("show");
			})
			$(".submenu").on("click", "a", function() {
				$(".submenu a.active").removeClass("active")
				$(this).addClass("active");
				var $me = "table" + $(this).attr("data-id");

				$("#" + $me).show().siblings("table").hide();
			});
			/*新增分类*/
			$('#js-addGroup').click(function() {
				$('#addDoorModal input[type=text]').val('');
				$('#addDoorModal select').val('');
				$('#addDoorModal').modal('show');
				$('#depart').trigger('chosen:updated');
			})
		})
		//获取标签
	function getdata() {

		var param = {
			"sessionKey": session.sessionKey,
			"sessionId": session.sessionId
		}
		$.ajax({

			type: 'post',
			url: service + "label/find_all",
			dataType: "json",
			data: param,
			async: false,
			success: function(data) {

				console.log(JSON.stringify(data));
				if(data.ret == 'ok') {
					var item = data.item;
					var str = '';
					for(var i = 0; i < item.length; i++) {
						var piditem = {
							labelName: item[i].labelName,
							pid: item[i].id
						};
						select.push(piditem);
						str += ' <li><a href="javascript:;"  data-id="' + item[i].id + '"><i></i>' + item[i].labelName + '</a> <ul>';
						var tablestr2 = '<table id="table' + item[i].id + '"  class="table table-striped table-bordered cardTable table-datatable table-hover"><tr><th style="width:40px">' +
							'<input type="checkbox" name="" id="" value="" /></th>' +
							'  <th style="width:80px">序列</th>' +
							' <th style="width:100px">名称</th>' +

							' <th  style="width:300px">颜色</th>' +

							' <th style="width:140px">操作</th> </tr>';
						if(item[i].sub) {
							for(var j = 0; j < item[i].sub.length; j++) {
								var subitem = {
									labelName: item[i].sub[j].labelName,
									pid: item[i].sub[j].id
								};
								select.push(subitem);
								str += ' <li ><a href="javascript:;" data-id="' + item[i].sub[j].id + '">' + item[i].sub[j].labelName + '</a></li>';
								tablestr2 += ' <tr data-id="' + item[i].sub[j].id + '"><td ><input type="checkbox" name="" id="" value="" /></td><td>' + (j + 1) + '</td><td>' + item[i].sub[j].labelName + '</td>' +
									'<td><a href="javascript:void(0)" class="changecolor" style="background:' + item[i].sub[j].labelColor + '"></a></td><td ><a href="javascript:void(0)" class="editBtn">编辑</a><a href="javascript:void(0)" class="delBtn">删除</a></td></tr>';
								if(item[i].sub[j].sub) {
									var tablestr = '<table id="table' + item[i].sub[j].id + '"  class="table table-striped table-bordered cardTable table-datatable"><tr><th style="width:40px">' +
										'<input type="checkbox" name="" id="" value="" /></th>' +
										'  <th style="width:200px">序列</th>' +
										' <th>名称</th>' +

										' <th  style="width:300px">颜色</th>' +

										' <th style="width:160px">操作</th> </tr>';
									for(var h = 0; h < item[i].sub[j].sub.length; h++) {
										tablestr += ' <tr data-id="' + item[i].sub[j].sub[h].id + '"><td ><input type="checkbox" name="" id="" value="" /></td><td>' + (h + 1) + '</td><td>' + item[i].sub[j].sub[h].labelName + '</td>' +
											'<td><a href="javascript:void(0)" class="changecolor" style="background:' + item[i].sub[j].sub[h].labelColor + '"></a></td><td ><a href="javascript:void(0)" class="editBtn">编辑</a><a href="javascript:void(0)" class="delBtn">删除</a></td></tr>';
									}
									$(".cols-main").append(tablestr + '</table>');

								}
							}
						}
						str += '</ul></li>';

						$(".cols-main").append(tablestr2 + '</table>');

					}
					//alert(str);
					$(".submenu ul.bd").html(str);
					$(".submenu ul.bd li").eq(0).find("a").eq(0).addClass("active");
					var obj = ".cols-main table#table" + data.item[0].id;

					$(obj).show().siblings("table").hide();
					// alert(JSON.stringify(select));
					var depart = '';
					for(var i = 0; i < select.length; i++) {
						depart += ' <option value="' + select[i].pid + '">' + select[i].labelName + '</option>'
					}
					$("#depart").html(depart);
					$("#depart").chosen();
				}

			},
			error: function() {
				alert("发生错误");
			}
		});
	}
	$("#addlabelBtn").click(function() {
			if(!$("#labelName").val()) {
				alert("请输入标签名称");
				return false;
			}
			var depart = $("#depart").val();
			var param = {
					"pid": $("#depart").val(),
					"labelColor": $("#changecolorbox .colortag .active").css("backgroundColor"),
					"labelName": $("#labelName").val(),
					"sessionKey": session.sessionKey,
					"sessionId": session.sessionId
				}
				// alert(JSON.stringify(param));
			$.ajax({

				type: 'post',
				url: service + "label/save_base_label",
				dataType: "json",
				data: param,
				success: function(data) {

					console.log(JSON.stringify(data));
					$.zui.messager.show('新增成功', {
						placement: 'top',
						time: '1000'
					});
					if(data.ret == 'ok') {
						$("#addDoorModal").modal("hide");
						$(".submenu ul.bd").html('');
						$(".cols-main").html('');
						getdata();
						//alert(depart);
						var str = '.submenu ul li a[data-id=' + depart + ']';
						$(str).click();
					}

				},
				error: function() {
					alert("发生错误");
				}
			});
		})
		//确认编辑
	function confirmEditBtn() {
		var tabId = $("#tabId").val();

		var labelName = $("#editName").val();
		if(!labelName) {
			alert("请输入标签名称");
			return false;
		}
		var labelId = $("#editId").val();
		var labelColor = $("#changecolormodal .colortag .active").css("backgroundColor") || '';
		var param = {
				id: labelId,
				"labelColor": labelColor,
				"labelName": labelName,
				"sessionKey": session.sessionKey,
				"sessionId": session.sessionId
			}
			// alert(JSON.stringify(param));
		$.ajax({

			type: 'post',
			url: service + "label/update_base_label",
			dataType: "json",
			data: param,
			success: function(data) {

				console.log(JSON.stringify(data));
				$.zui.messager.show('编辑成功', {
					placement: 'top',
					time: '1000'
				});
				if(data.ret == 'ok') {
					$("#editmodal").modal("hide");
					$(".submenu ul.bd").html('');
					$(".cols-main").html('');
					getdata();

					var dataId = tabId.substring(5, tabId.length);
					var str = '.submenu ul li a[data-id=' + dataId + ']';

					$(str).click();
				}

			},
			error: function() {
				alert("发生错误");
			}
		});
	}
	//删除
	function confirmDelBtn() {
		var tabId = $("#deltabId").val();
		var labelId = $("#confirmDelId").val();
		var param = {
			id: labelId,
			"sessionKey": session.sessionKey,
			"sessionId": session.sessionId
		}

		$.ajax({

			type: 'post',
			url: service + "label/delete_base_label",
			dataType: "json",
			data: param,
			success: function(data) {

				console.log(JSON.stringify(data));
				$.zui.messager.show(data.reason, {
					placement: 'top',
					time: '1000'
				});
				if(data.ret == 'ok') {
					$("#confirmModal").modal("hide");
					$(".submenu ul.bd").html('');
					$(".cols-main").html('');
					getdata();
					var dataId = tabId.substring(5, tabId.length);
					var str = '.submenu ul li a[data-id=' + dataId + ']';
					$(str).click();
				}

			},
			error: function() {
				alert("发生错误");
			}
		});
	}
</script>