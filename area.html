<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="UTF-8">
		<title>区域</title>
		<link href="css/zui.css" rel="stylesheet" />
		<link href="css/common.css" rel="stylesheet" />
		<link href="css/page.css" rel="stylesheet" />
		<script src="js/jquery-1.9.1.min.js"></script>
		<script src="js/zui.js"></script>
		<script src="js/common.js"></script>
		<link rel="stylesheet" type="text/css" href="css/chosen.css" />
		<script src="js/chosen.js" type="text/javascript" charset="utf-8"></script>
		<style type="text/css">
			.chosen-container {
				width: 400px !important;
			}
		</style>
	</head>

	<body class="minwidth1080">
		<div class="head">
			<div class="modal fade  addModal" id="addProModal">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">关闭</span></button>
							<h4 class="modal-title">编辑区域省份</h4>
						</div>
						<div class="modal-body">
							<form method="" action="" class="modal-form">
								<form method="" action="" class="modal-form">
									<input type="hidden" name="editProID" id="editProID" value="" />
									<p>
										<label for="">选择省市</label>
										<select id="selectPro" multiple="" style="width: 400px;">
											<option value="" selected="selected"></option>
										</select>
									</p>

								</form>
							</form>
						</div>
						<div class="modal-footer text-center">
							<button type="button" class="btn btn-primary" onclick="addareaPro()">确定</button>
							<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
						</div>
					</div>
				</div>
			</div>
			<div class="modal fade addModal" id="addModal">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">关闭</span></button>
							<h4 class="modal-title">新建</h4>
						</div>
						<div class="modal-body">
							<form method="" action="" class="modal-form">
								<form method="" action="" class="modal-form">
									<p>
										<label for="">区域名称</label>
										<input type="text" id="addareaName">
									</p>
								</form>
							</form>
						</div>
						<div class="modal-footer text-center">
							<button type="button" class="btn btn-primary" onclick="addarea()">确定</button>
							<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
						</div>
					</div>
				</div>
			</div>

			<div class="modal fade addModal" id="editModal">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">关闭</span></button>
							<h4 class="modal-title">编辑</h4>
						</div>
						<div class="modal-body">
							<form method="" action="" class="modal-form">
								<form method="" action="" class="modal-form">
									<input type="hidden" name="" id="editId" value="" />
									<p>
										<label for="">区域名称</label>
										<input type="text" id="editareaName">
									</p>

								</form>
							</form>
						</div>
						<div class="modal-footer text-center">
							<button type="button" class="btn btn-primary" onclick="editarea()">确定</button>
							<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
						</div>
					</div>
				</div>
			</div>
			<div class="modal fade" id="confirm">
				<div class="modal-dialog modal-sm ">
					<div class="modal-content">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">关闭</span></button>
							<h4 class="modal-title">确认禁用</h4>
						</div>
						<div class="modal-body">
							<form method="" action="" class="modal-form">

								<p>
									您确定要删除这项吗？

								</p>

							</form>
						</div>
						<div class="modal-footer text-center">
							<button type="button" class="btn btn-primary" onclick="confirmDelBtn()">确定</button>
							<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
						</div>
					</div>
				</div>
			</div>
			<ol class="breadcrumb">
				<li>
					<a href="your/url/"><i class="icon icon-home"></i>当前位置</a>
				</li>
				<li>
					<a href="your/url/">设置</a>
				</li>
				<li class="active">区域</li>
			</ol>
			<div class="row operationbar">
				<div class="col-md-7">
					<button class="btn btn-primary" type="button" id='js-addArea'>新增区域</button>
					<!--<button class="btn" type="button">删除</button>-->
				</div>
				<div class="col-md-5">
					<!--<div class="input-group">
						<span class="input-group-addon"><i class="icon-search"></i></span>
						<input type="text" class="form-control">

						<span class="input-group-btn">
                        <button class="btn btn-default" type="button">搜索</button>
                    </span>
					</div>-->

				</div>
			</div>

		</div>
		<div class="main arealist">
			

		</div>

	</body>

</html>
<script>
	var $me = '',
		delId = '';
	$(function() {

		getdata();
		allProvince();
		/*添加区域*/
		$('#js-addArea').click(function() {
			$("#addModal input[type=text]").val('');
			$("#addModal").modal("show");
		})
		$('.arealist').on('click', 'dt a.edit', function() {
			var areaName = $(this).parents('dt').find('span').text();
			var areaId = $(this).parents('dt').attr('data-id');
			$('#editareaName').val(areaName);
			$('#editId').val(areaId);
			$('#editModal').modal('show');
		})
		$('.arealist').on('click', 'dt a.del', function() {
			$('#confirm').modal('show');
			$me = $(this).parents('dl');
			delId = $(this).parents('dt').attr('data-id');

		});
		$('.arealist').on('click', 'dd a.editPro', function() {
			$('#editProID').val($(this).parents('dl').find('dt').attr('data-id'));
			$('#selectPro option').removeAttr('selected');
			//$('#selectPro option:eq(3)').attr('selected', 'selected');
			$(this).prev('.area-taglist').find('span').each(function() {
				var option = $(this).attr('data-id');

				$('#selectPro option[value="' + option + '"]').attr('selected', 'selected');
			});
			$('#selectPro').trigger('chosen:updated');
			$('#addProModal').modal('show');
		})
	})

	function getdata() {
		var param = {
			"sessionKey": session.sessionKey,
			"sessionId": session.sessionId
		}
		$.ajax({

			type: 'post',
			url: service + "area/get_all_area",
			dataType: "json",
			data: param,
			async: false,
			success: function(data) {

				//console.log("项目" + JSON.stringify(data));
				if(data.ret == 'ok') {
					var html = '';
					for(var i = 0; i < data.item.length; i++) {
						html += '<dl><dt data-id="' + data.item[i].id + '"><label><span>' + data.item[i].name + '</span></label><a href="javascript:;" class="edit">编辑</a><a href="javascript:;" class="del">删除</a></dt>' +
							'<dd><span class="area-taglist"></span><a href="javascript:;" class="editPro">编辑</a></dd></dl>';
					}
					$('.arealist').html(html);
					$('.arealist dl').each(function() {
						var areaId = $(this).find('dt').attr('data-id');
						getlinkPro(areaId, this);
					})

				}

			},
			error: function() {
				alert("发生错误");
			}
		});

	}

	function addarea() {
		var addareaName = $("#addareaName").val();
		if(addareaName == '') {
			$.zui.messager.show('区域名称不能为空', {
				placement: 'top',
				time: '1000'
			});

			return false;
		}
		var param = {
			"name": addareaName,
			"sessionKey": session.sessionKey,
			"sessionId": session.sessionId
		}
		$.ajax({

			type: 'post',
			url: service + "area/save_area",
			dataType: "json",
			data: param,
			async: false,
			success: function(data) {

				//console.log("项目" + JSON.stringify(data));
				if(data.ret == 'ok') {
					$("#addModal").modal("hide");
					$(".arealist").html("");

					getdata();
				}

			},
			error: function() {
				alert("发生错误");
			}
		});
	}

	function editarea() {
		var editId = $('#editId').val();
		var editareaName = $('#editareaName').val();
		var param = {
			"id": editId,
			"name": editareaName,
			"sessionKey": session.sessionKey,
			"sessionId": session.sessionId
		}
		$.ajax({

			type: 'post',
			url: service + "area/update_area",
			dataType: "json",
			data: param,
			async: false,
			success: function(data) {

				//console.log("项目" + JSON.stringify(data));
				if(data.ret == 'ok') {
					$("#editModal").modal("hide");
					$(".arealist").html("");

					getdata();
				}

			},
			error: function() {
				alert("发生错误");
			}
		});
	}

	function confirmDelBtn() {
		var param = {
			"id": delId,
			"sessionKey": session.sessionKey,
			"sessionId": session.sessionId
		}
		$.ajax({

			type: 'post',
			url: service + "area/delete_area",
			dataType: "json",
			data: param,
			async: false,
			success: function(data) {

				//console.log("项目" + JSON.stringify(data));
				if(data.ret == 'ok') {
					$('#confirm').modal('hide');
					$.zui.messager.show('删除成功', {
						placement: 'top',
						time: '1000'
					});

					$me.remove();
				}

			},
			error: function() {
				alert("发生错误");
			}
		});
	}
	/*获取全部省份*/
	function allProvince() {
		var param = {

			"sessionKey": session.sessionKey,
			"sessionId": session.sessionId
		}
		$.ajax({

			type: 'post',
			url: service + "base_province/get_all_province",
			dataType: "json",
			data: param,
			async: false,
			success: function(data) {

				console.log("区域" + JSON.stringify(data));
				if(data.ret == 'ok') {
					var html = '';
					for(var i = 0; i < data.item.length; i++) {
						html += '<option value="' + data.item[i].id + '" >' + data.item[i].name + '</option>';
					}
					$('#selectPro').html(html);
					$('#selectPro').chosen();
				}

			},
			error: function() {
				alert("发生错误");
			}
		});
	}
	/*确定关联区域的省份*/
	function addareaPro() {
		var idlist ='';
		if($('#selectPro').val()){
			idlist=JSON.stringify($('#selectPro').val())
		}
		
		
	/*	$('#selectPro option:selected').each(function() {

			idlist.push($(this).val());
		});*/
	
		var areaId = $('#editProID').val();
		var param = {
			"areaId": areaId,
			"provinceIds":idlist,
			"sessionKey": session.sessionKey,
			"sessionId": session.sessionId
		}
		//	alert(JSON.stringify(param));
		$.ajax({

			type: 'post',
			url: service + "area/link_area_province",
			dataType: "json",
			data: param,
			async: false,
			success: function(data) {

				console.log("关联区域" + JSON.stringify(data));
				/*if(data.ret == 'ok') {
					
				}*/
				$('#addProModal').modal('hide');
				$.zui.messager.show(data.reason, {
					placement: 'top',
					time: '1000'
				});
				var obj = $('.arealist dl dt[data-id=' + areaId + ']').parent('dl');

				getlinkPro(areaId, obj)

			},
			error: function() {
				alert("发生错误");
			}
		});
	}
	/*获取区域关联省份*/
	function getlinkPro(areaId, obj) {

		var param = {
				"areaId": areaId,
				"sessionKey": session.sessionKey,
				"sessionId": session.sessionId
			}
			//alert(JSON.stringify(param));
		$.ajax({

			type: 'post',
			url: service + "area/get_link_province",
			dataType: "json",
			data: param,
			async: false,
			success: function(data) {

				console.log("获取关联省份" + JSON.stringify(data));
				if(data.ret == 'ok') {
					if(data.item != null) {
						var html = '';
						for(var i = 0; i < data.item.length; i++) {
							html += '<span class="area-tag" data-id="' + data.item[i].id + '">' + data.item[i].name + '</span>';
						}
						$(obj).find('.area-taglist').html(html);
					}
				}

			},
			error: function() {
				alert("发生错误");
			}
		});
	}
</script>