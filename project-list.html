<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<link href="css/zui.css" rel="stylesheet" />
		<link href="css/chosen.css" rel="stylesheet" />
		<link href="css/common.css" rel="stylesheet" />
		<link href="css/page.css" rel="stylesheet" />
		<script src="js/jquery-1.9.1.min.js"></script>
		<script src="js/zui.js"></script>
		<script src="js/chosen.js"></script>
		<script src="js/common.js"></script>
	</head>

	<body class="minwidth1080">
		<div class="head">

			<ol class="breadcrumb">
				<li>
					<a href="your/url/"><i class="icon icon-home"></i>当前位置</a>
				</li>
				<li>
					<a href="your/url/">查询</a>
				</li>
				<li class="active">项目查询</li>
			</ol>
			<div class="row operationbar">
				<div class="col-md-7">
				</div>
				<div class="col-md-5">
					<div class="input-group">
						<span class="input-group-addon"><i class="icon-search"></i></span>
						<input type="text" class="form-control" id="searchKey">
						<span class="input-group-addon input-remove"><i class="icon-remove-circle"></i></span>
						<span class="input-group-btn">
                        <button class="btn btn-default" type="button">搜索</button>
                    </span>
					</div>
					<div class="search-group hidden" id='searchlist'>
						<div class="list-group">
							<a href="#" class="list-group-item active" data-type="projectName">
								在项目名称中查找：
								<span></span>
							</a>
							<a href="#" class="list-group-item" data-type="shortName">
								在项目简称中查找：
								<span></span>
							</a>
							<a href="#" class="list-group-item " data-type="name">
								在维护人姓名中查找：
								<span></span>
							</a>
							<a href="#" class="list-group-item" data-type="describer">
								在项目描述中查找：
								<span></span>
							</a>
						</div>
					</div>
				</div>
			</div>
			<div class="searchbar">
				<label>分类</label>
				<select class="chosen-select form-control" id="moduleCategory" multiple="">
				</select>
				<label class="ml10">标签</label>
				<select class="chosen-select form-control" id="labelType" multiple="">
				</select>
				<label class="ml10">省份</label>
				<select class="chosen-select form-control" id="provinces" multiple="">
				</select>
				<label class="ml10">状态</label>
				<select class="form-control" id="repairType">
					<option value="">全部</option>
					<option value="有效">有效</option>
					<option value="删除">删除</option>

				</select>
			</div>
		</div>
		<div class="main">
			<table class="table table-striped table-bordered cardTable table-datatable datatable">
				<thead>
					<tr>
						<th style="width: 7%">序号</th>
						<th style="width: 10%">项目名称</th>
						<th style="width: 10%">项目简称</th>
						<th style="width: 10%">分类</th>
						<th style="width: 10%">标签</th>
						<th style="width: 20%">维护人姓名</th>
						<th style="width: 20%">项目描述</th>
						<th style="width: 10%">状态</th>
					</tr>
				</thead>
				<tbody>
				</tbody>

			</table>
		</div>
		<div class="footer row">
			<div class="col-md-8 leftpage">
				<span class="ml10">总计：<span class="total">0</span>人</span>
				<label class="ml40">显示</label>
				<select class="form-control" id="pageSize">
					<!--<option value="10">10</option>
					<option value="20">20</option>-->
					<option value="50">50</option>
					<option value="100">100</option>
				</select>
				<label>行</label>
			</div>
			<div class="text-right col-md-4">
				<ul class="pager ">

				</ul>
				<input type="text" id="numtxt" />
				<input type="submit" value="跳转" class="btn" id="gotopage" />
			</div>
		</div>

	</body>

</html>
<script type="text/javascript">
	//初始化数据表
	var page = 1,
		pageSize = 50,
		pagecount = 0;
	$(function() {
		show_province();//获取省市
		
		$('#searchlist .list-group a').click(function() {
			$('#searchlist .list-group a.active').removeClass('active');
			$(this).addClass('active');
		});
		$('.input-group-btn .btn-default').click(function() {
			page = 1;
			getdata(page);
		});
		searchkey();
		getCategory('项目');//获取项目的分类
		getTags('项目');//获取项目的标签
		getdata(page);
	}); //页面大小选择
	$("#pageSize").bind("change", function() {
		if ($(this).val() == 0) {
			return;
		} else {
			pageSize = $(this).val();
			page = 1;
			getdata(page);
		}
	});
/*获取项目列表*/
	function getdata(page) {
		//获取分类的值
		var categorys = '';
		if ($('#moduleCategory').val() != null) {
			categorys = JSON.stringify($('#moduleCategory').val());
		}
		//获取标签的值
		var labels = '';
		if ($('#labelType').val() != null) {
			labels = JSON.stringify($('#labelType').val());
		}
		//获取状态
		var status = $('#repairType').val();
		var name = '';
		var projectName = '';
		var shortName = '';
		var describer = '';
		var type = $('#searchlist .list-group-item.active').attr('data-type');
		if (type == 'name') {
			name = $('#searchKey').val();
		} else if (type == 'projectName') {
			projectName = $('#searchKey').val();
		} else if (type == 'shortName') {
			shortName = $('#searchKey').val();
		} else if (type == 'describer') {
			describer = $('#searchKey').val();
		}
		var param = {
			"categorys": categorys,
			"labels": labels,
			"name": name,
			"projectName": projectName,
			"shortName": shortName,
			"pageSize": pageSize,
			"describer": describer,
			"page": page,
			"pageSize": pageSize,
			"status": status,
			"sessionKey": session.sessionKey,
			"sessionId": session.sessionId
		}
		console.log("参数" + JSON.stringify(param));
		$.ajax({
			type: 'post',
			url: service + "project/search",
			dataType: "json",
			data: param,
			success: function(data) {
				console.log("查询结果" + JSON.stringify(data));
				if (data.ret == 'ok') {
					var result = data.item;
					pagecount = Math.ceil(data.totalSize / pageSize);
					_TOTAL = pagecount;
					_NUM = data.page;
					pager(_NUM, _TOTAL);
					var str = "";
					if (data.item) {
						for (var i = 0; i < data.item.length; i++) {
							str += ' <tr data-id="' + data.item[i].userId + '">' +
								'<td>' + ((page - 1) * pageSize + (i + 1)) + '</td>' +
								'<td>' + data.item[i].projectName + '</td>' +
								'<td>' + data.item[i].shortName + '</td>';
							var baseCategory = "";
							if (data.item[i].baseCategory) {
								baseCategory = data.item[i].baseCategory.categoryName;
							}
							var labels = "";
							if (data.item[i].labels) {
								//alert(data.item[i].labels.length);
								for (var g = 0; g < data.item[i].labels.length; g++) {
									//alert(data.item[i].labels[g].labelName);
									if (data.item[i].labels[g]) {
										labels += data.item[i].labels[g].labelName;
									}
								}
							}
							//alert('显示'+JSON.stringify(labels));
							var contacts = '';
							if (data.item[i].contacts) {
								for (var j = 0; j < data.item[i].contacts.length; j++) {
									contacts += data.item[i].contacts[j].name + ',';
								}
							}
							str += '<td>' + baseCategory + '</td>' +
								'<td>' + labels + '</td>' +
								'<td>' + contacts + '</td>' +
								'<td>' + data.item[i].describer + '</td>' +
								'<td>' + data.item[i].status + '</td>' +
								'</tr>';
						}
						$('table tbody').html(str);
						$(".total").text(data.totalSize);
					}
				}
			},
			error: function() {
				alert("发生错误");
			}
		});
	}
/*查询所有省市*/
	function show_province() {
		var param = {
			sessionId: session.sessionId,
			sessionKey: session.sessionKey,
			lastSynchTime: "",
			synchType: "0"
		}
		$.ajax({
			type: "post",
			url: service + "base_province/get_all",
			dataType: "json",
			data: param,
			success: function(data) {
				//console.log("显示省份" + JSON.stringify(data));
				if (data.ret == 'ok') {
					var result = data.item;
					if (result) {
						var str = '';
						for (var i = 0; i < result.length; i++) {
							str += ' <optgroup label="' + result[i].name + '">';
							if (result[i].children) {
								for (var j = 0; j < result[i].children.length; j++) {
									str += '<option value="' + result[i].children[j].id + '">' + result[i].children[j].name + '</option>';
								}
							}
							str += ' </optgroup>';
						}
						$('#provinces').append(str);
						$('#provinces').chosen();
					}
				};
			}
		});
	}
</script>