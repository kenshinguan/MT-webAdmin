<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="UTF-8">
		<title>权限</title>
		<link href="css/zui.css" rel="stylesheet" />
		<link href="lib/datatable/zui.datatable.min.css" rel="stylesheet" />
		<link href="css/common.css" rel="stylesheet" />
		<link href="css/page.css" rel="stylesheet" />
		<script src="js/jquery-1.9.1.min.js"></script>
		<script src="js/zui.js"></script>
		<script src="lib/datatable/zui.datatable.min.js"></script>
		<script src="js/common.js"></script>
	</head>

	<body class="minwidth1080">
		<div class="head">
			<div class="modal fade addModal" id="addModal">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">关闭</span></button>
							<h4 class="modal-title">新建</h4>
						</div>
						<div class="modal-body">
							<form method="" action="" class="modal-form">
								<input type="hidden" id="permissionId" />

								<p>
									<label for="">名称</label>
									<input type="text" class="name" />

								</p>
								<p>
									<label for="">类型</label>
									<select id="type">
										<option>设备</option>
										<option>项目</option>
										<option>联系人</option>
									</select>

								</p>
							</form>
						</div>
						<div class="modal-footer text-center">
							<button type="button" class="btn btn-primary" id="confirmBtn">确定</button>
							<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
						</div>
					</div>
				</div>
			</div>
			<div class="modal fade" id="confirm">
				<div class="modal-dialog modal-sm ">
					<div class="modal-content">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">关闭</span></button>
							<h4 class="modal-title">确认删除</h4>
						</div>
						<div class="modal-body">
							<form method="" action="" class="modal-form">
								<input type="hidden" id="delId" />
								<p>
									您确定要删除这几项吗？

								</p>

							</form>
						</div>
						<div class="modal-footer text-center">
							<button type="button" class="btn btn-primary" onclick="confirmDelBtn()">确定</button>
							<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
						</div>
					</div>
				</div>
			</div>
			<ol class="breadcrumb">
				<li>
					<a href="your/url/"><i class="icon icon-home"></i>当前位置</a>
				</li>
				<li>
					<a href="your/url/">设置</a>
				</li>
				<li class="active">权限</li>
			</ol>
			<div class="row operationbar">
				<div class="col-md-7">

					<!--   <button class="btn btn-primary" type="button" id="addPermission">新增</button>
                <button class="btn" type="button" onclick="delItem()">删除</button>-->
				</div>
				<div class="col-md-5">
					<div class="input-group">
						<span class="input-group-addon"><i class="icon-search"></i></span>
						<input type="text" class="form-control">

						<span class="input-group-btn">
                        <button class="btn btn-default" type="button">搜索</button>
                    </span>
					</div>

				</div>
			</div>
			<div class="searchbar">
				<label>权限类型</label>
				<select class="form-control" id="permType">
					<option value="">全部</option>
					<option value="项目">项目</option>
					<option value="设备">设备</option>
					<option value="联系人">联系人</option>
					<option value="反馈">反馈</option>
					<option value="返修单">返修单</option>
					<option value="任务单">任务单</option>
					<option value="费用单">费用单</option>
				</select>

			</div>
		</div>
		<div class="main">
			<div class='cols-wrap' style="padding-left: 0">
				<div class="cols-main" style="width: 50%;">
					<table class="table table-striped table-bordered cardTable table-datatable" >
						<thead>
							<tr>
								<th style="width:7%;">序号</th>
								
							<!--	<th>权限id</th>-->
								<th style="width:20%;">权限名称</th>
								<th style="width:15%;">是否有权限</th>
							</tr>
						</thead>
						<tbody>
						</tbody>
					</table>
				</div>

			</div>

		</div>

	</body>

</html>
<script>
	//初始化数据表
	//$('.datatable').datatable({
	//    checkable: true,
	//    sortable: true
	//});

	//禁用方法
	function delItem() {
		var isfalg = $("table tr.active").length > 0 ? true : false;
		if(isfalg) {
			$("#confirm").modal("show");

		} else {
			var msg = $.zui.messager.show('请至少选择一个员工', {
				placement: 'top',
				time: '1000'
			});

		}
	}
	$(function() {
		$('.submenu .bd> li>a').click(function() {
			if($(this).parent('li').hasClass('open')) {
				$(this).parent('li').removeClass('open');
			} else {
				$('.submenu .bd> li.open').removeClass('open')
				$(this).parent('li').addClass('open');
			}
		})
		$(".submenu").on("click", "a", function() {
			$(".submenu a.active").removeClass("active")
			$(this).addClass("active");
			getpower($(this).parents("li").attr("data-id"));
		})
		$(".main ").on("click", ".editBtn", function() {
			var $me = $(this).parents("tr");
			$("#addModal .modal-title").text("编辑");

			$("#permissionId").val($me.find("td").eq(1).text());
			$(".name").val($me.find("td").eq(2).text());
			$("#type").val($me.find("td").eq(3).text());
			$("#addModal").modal("show");
		})
		$(".main ").on("click", ".delBtn", function() {
			var $me = $(this).parents("tr");
			$("#delId").val($me.find("td").eq(1).text());
			$("#confirm").modal("show");
		})
		$("#addPermission").click(function() {
			$("#addModal .modal-title").text("新建");
			$("#permissionId").val("");
			$("#addModal").modal("show");
		})
		$("#confirmBtn").click(function() {
				var permissionId = $("#permissionId").val();

				if(permissionId) {

					editpermissions();
				} else {
					addpermissions();
				}
			})
			/*权限类型*/
		$('#permType').change(function() {
			var type = $(this).val();
			getdata(type);
		})
		getdata('');

	})

	function getdata(type) {
		var param = {
			"module":type,
			"sessionKey": session.sessionKey,
			"sessionId": session.sessionId
		}
		//alert(JSON.stringify(param));
		$.ajax({

			type: 'post',
			url: service + "power/find_user_power",
			dataType: "json",
			data: param,
			success: function(data) {

				console.log(JSON.stringify(data));
				if(data.ret == 'ok') {
					var item = data.item;
					var str = '';
					var n = 0;
					if(item) {
						for(var i = 0; i < item.length; i++) {
							for(var j = 0; j < item[i].sub.length; j++) {
								var sub = item[i].sub[j];
								for(var h = 0; h < sub.sub.length; h++) {
									var mod = sub.sub[h];
									str += ' <tr data-id="' + mod.id + '">' +
										'<td>' + (++n) + '</td>' +
										'<td style="display:none;">' + mod.id + '</td>' +
										'<td>' + item[i].name + '-' + sub.name + '-' + mod.name + '</td>' +
										'<td>' + mod.isCheck + '</td>' +

										' </tr>';
								}
							}
							/*  str += ' <tr data-id="' + item[i].id + '">' +
							       '<td>' + (i + 1) + '</td>' +
							      '<td>' + item[i].id + '</td>' +
							      '<td>' + item[i].name + '</td>' +
							      '<td>' + item[i].type + '</td>' +
							        '<td><a href="javascript:void(0)" class="editBtn">编辑</a><a href="javascript:void(0)" class="delBtn">删除</a></td>' +
							      ' </tr>';*/
						}
					}
					$("table tbody").html(str);
				}

			},
			error: function() {
				alert("发生错误");
			}
		});

	};
	//添加

	function addpermissions() {
		var name = $(".name").val();
		var type = $("#type").val();
		var param = {
			"name": name,
			"type": type,
			"sessionKey": session.sessionKey,
			"sessionId": session.sessionId
		}
		console.log(JSON.stringify(param));
		$.ajax({

			type: 'post',
			url: service + "power/save_user_power",
			dataType: "json",
			data: param,
			success: function(data) {

				console.log(JSON.stringify(data));
				if(data.ret == 'ok') {
					var item = data.item;
					var msg = $.zui.messager.show(data.reason, {
						placement: 'top',
						time: '1000'
					});
					$("#addModal").modal("hide");
					getdata();
				}

			},
			error: function() {
				alert("发生错误");
			}
		});
	}
	//编辑
	function editpermissions() {
		var permissionId = $("#permissionId").val();
		var name = $(".name").val();
		var type = $("#type").val();
		var param = {
			"id": permissionId,
			"name": name,
			"type": type,
			"sessionKey": session.sessionKey,
			"sessionId": session.sessionId
		}
		console.log(JSON.stringify(param));
		$.ajax({

			type: 'post',
			url: service + "power/modify_user_power",
			dataType: "json",
			data: param,
			success: function(data) {

				console.log(JSON.stringify(data));
				if(data.ret == 'ok') {
					var item = data.item;
					var msg = $.zui.messager.show(data.reason, {
						placement: 'top',
						time: '1000'
					});
					$("#addModal").modal("hide");
					getdata();
				}

			},
			error: function() {
				alert("发生错误");
			}
		});
	}
	//删除
	function confirmDelBtn() {
		var delId = $("#delId").val();

		var param = {
			"id": delId,

			"sessionKey": session.sessionKey,
			"sessionId": session.sessionId
		}
		console.log(JSON.stringify(param));
		$.ajax({

			type: 'post',
			url: service + "power/delete_user_power",
			dataType: "json",
			data: param,
			success: function(data) {

				console.log(JSON.stringify(data));
				if(data.ret == 'ok') {
					var item = data.item;
					var msg = $.zui.messager.show(data.reason, {
						placement: 'top',
						time: '1000'
					});
					$("#confirm").modal("hide");
					getdata();
				}

			},
			error: function() {
				alert("发生错误");
			}
		});
	}
</script>