<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="UTF-8">
		<title>版本</title>
		<link href="css/zui.css" rel="stylesheet" />
		<link href="lib/datatable/zui.datatable.min.css" rel="stylesheet" />
		<link href="css/common.css" rel="stylesheet" />
		<link href="css/page.css" rel="stylesheet" />
		<script src="js/jquery-1.9.1.min.js"></script>
		<script src="js/zui.js"></script>
		<script src="lib/datatable/zui.datatable.min.js"></script>
		<script src="js/common.js"></script>
		<link rel="stylesheet" type="text/css" href="css/dropzone.css" />
		<link rel="stylesheet" type="text/css" href="css/datetimepicker.css" />
		<script src="js/dropzone.js" type="text/javascript" charset="utf-8"></script>
	</head>

	<body class="minwidth1080">
		<div class="head">
			<div class="modal fade addModal" id="addModal">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">关闭</span></button>
							<h4 class="modal-title">新建</h4>
						</div>
						<div class="modal-body ">
							<div class="addfilebox">
								<p>
									<label>版本类型</label>
									<select style="width: 480px;" class="deviceType">
										<option>类型</option>
									</select>
								</p>
								<p>
									<label for="">ftp服务器</label>
									<select style="width: 480px;" class="FTPType">
										<option>类型</option>
									</select>
								</p>
								<p><label for="">添加附件</label>
									<input type="file" name="" class="file" id="" value="" style="width: 300px; display: inline-block;" />
								</p>
							</div>
							<p class="text-center uploadfilebox" style="color: #f00;">*设备版本已经存在，是否需要替换版本</p>
						</div>
						<div class="modal-footer text-center">
							<button type="button" class="btn btn-primary" onclick="addVersion()">确定</button>
							<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
						</div>
					</div>
				</div>
			</div>

			<div class="modal fade" id="confirm">
				<div class="modal-dialog modal-sm ">
					<div class="modal-content">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">关闭</span></button>
							<h4 class="modal-title">确认删除</h4>
						</div>
						<div class="modal-body">
							<form method="" action="" class="modal-form">
								<input type="hidden" id="delId" />
								<p>
									您确定要删除这个版本吗？

								</p>

							</form>
						</div>
						<div class="modal-footer text-center">
							<button type="button" class="btn btn-primary" onclick="confirmDelBtn()">确定</button>
							<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
						</div>
					</div>
				</div>
			</div>

			<div class="modal fade addModal" id="editModal">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">关闭</span></button>
							<h4 class="modal-title">编辑</h4>
						</div>
						<div class="modal-body">
							<form method="" action="" class="modal-form">
								<input type="hidden" value="" id="editId" />
								<div class="hidden">
									<p>
										<label>版本类型</label>
										<select style="width: 480px;" id="editdeviceType" class="deviceType">
											<option>类型</option>
										</select>
									</p>
									<p>
										<label for="">ftp服务器</label>
										<select style="width: 480px;" id="editFTPType" class="FTPType">
											<option>类型</option>
										</select>
									</p>
									<p><label for="">添加附件</label>
										<input type="file" name="" class="uploadfile" id="" value="" style="width: 300px; display: inline-block;" />
									</p>
								</div>
								<p>
									<a href="javascript:;" class="js-uploadfile">重传设备版本</a>
								</p>
								<p>
									<label for="">文件名</label>
									<input type="text" id="editname" style="width: 480px;" readonly="readonly" />
								</p>
								<p>
									<label for="">协议简称</label>
									<input type="text" id="editshortname" style="width: 480px;" readonly="readonly">
								</p>
								<p>
									<label for="">是否有效</label>
									<select name="" id="editStatus">
										<option value="发布">发布</option>
										<option value="有效">有效</option>
										<option value="无效">无效</option>
									</select>
									<label class="ml10">是否最新</label>
									<select name="" id='editNew'>
										<option value="是">是</option>
										<option value="否">否</option>
									</select>
								</p>

								<p>
									<label for="">备注</label>
									<textarea name="" rows="" cols="" id="remark"></textarea>
								</p>
							</form>
						</div>
						<div class="modal-footer text-center">
							<button type="button" class="btn btn-primary" onclick="confirmedit()">确定</button>
							<button type="button" class="btn btn-warning" onclick="confirmDelBtn()">删除</button>
							<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
						</div>
					</div>
				</div>
			</div>
			<ol class="breadcrumb">
				<li>
					<a href="your/url/"><i class="icon icon-home"></i>当前位置</a>
				</li>
				<li>
					<a href="your/url/">设置</a>
				</li>
				<li class="active">版本</li>
			</ol>
			<div class="row operationbar">
				<div class="col-md-7">
					<button class="btn btn-primary" type="button" data-moveable="true" id='js-addVersion'>新增</button>
				</div>
				<div class="col-md-5">
					<div class="input-group">
						<span class="input-group-addon"><i class="icon-search"></i></span>
						<input type="text" class="form-control" id="searchKey">
						<span class="input-group-addon input-remove"><i class="icon-remove-circle"></i></span>
						<span class="input-group-btn">
                        <button class="btn btn-default" type="button">搜索</button>
                    </span>
					</div>
					<div class="search-group hidden" id="searchlist">
						<div class="list-group ">
							<a href="#" class="list-group-item active" data-type="equipmentName">
								在简称中查找：
								<span>搜索</span>
							</a>
							<a href="#" class="list-group-item" data-type="equipmentMid">
								在文件名中查找：
								<span>搜索</span>
							</a>
						</div>
					</div>
				</div>
			</div>
			<div class="searchbar">
				<label>设备类型</label>
				<select class="form-control" id="filterdeviceType">

				</select>

				<label class="ml10">发布日期</label>
				<input type="text" name="" id="" value="" class="form-control time" readonly="readonly" />
				<label class="ml10">有效性</label>
				<select class="form-control" id='status'>
					<option value="发布">发布</option>
					<option value="有效">有效</option>
					<option value="无效">无效</option>
				</select>
				<label class="ml10">是否最新</label>
				<select class="form-control" id='isNew'>
					<option value="是">是</option>
					<option value="否">否</option>
				</select>
				<!--	<button type="button" class="btn" id="js-searchBtn"><i class="icon icon-search"></i>查询</button>-->
			</div>
		</div>
		<div class="main">
			<table class="table table-striped table-bordered cardTable table-datatable table-hover " id="verlist">
				<thead>
					<tr>
						<th style="width: 7%">序号</th>
						<th style="width: 120px">分类</th>
						<th style="width: 100px">前缀</th>
						<th style="width: 100px">协议编号</th>
						<th style="width: 100px">协议简称</th>
						<th style="width: 300px">文件名</th>
						<th style="width: 240px">发布日期</th>
						<th style="width: 100px">状态</th>
						<th style="width: 100px">最新</th>
						<th style="width: 200px;">备注</th>
						<th style="width: 100px;">操作</th>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td>1</td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td>
							<a href="javascript:;">编辑</a>
							<a href="javascript:;">发布</a>
						</td>
					</tr>
					<tr>
						<td>1</td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td>
							<a href="javascript:;">编辑</a>
						</td>
					</tr>
				</tbody>
			</table>

		</div>
		<div class="footer row">
			<div class="col-md-8 leftpage">
				<span class="ml10">总计：<span class="total">0</span></span>
				<label class="ml40">显示</label>
				<select class="form-control" id="pageSize">
					<!--<option value="10">10</option>
					<option value="20">20</option>-->
					<option value="50">50</option>
					<option value="100">100</option>
				</select>
				<label>行</label>
			</div>
			<div class="text-right col-md-4">
				<ul class="pager ">

				</ul>
				<input type="text" id="numtxt" />
				<input type="submit" value="跳转" class="btn" id="gotopage" />
			</div>
		</div>

	</body>

</html>
<script src="js/datetimepicker.js" type="text/javascript" charset="utf-8"></script>
<script>
	var page = 1,
		pageSize = 50,
		pagecount = 0,
		isreplace = false //是否替换;
	$(function() {
			getdata(page);
			getDeviceType(); /*获取设备版本类型*/
			getFTP(); /*获取ftp*/
			//$('#editModal').modal('show');
			$('.time').selecDay();
			/*搜索输入框*/
			//设备名称、MID搜索
			//searchkey();
			$('#searchlist .list-group a').click(function() {
				$('#searchlist .list-group a.active').removeClass('active');
				$(this).addClass('active');

			});
			$('.js-uploadfile').click(function() {
				$(this).parent('p').prev('div.hidden').removeClass('hidden');
			});
			//页面大小选择
			$("#pageSize").bind("change", function() {
				if($(this).val() == 0) {
					return;
				} else {
					pageSize = $(this).val();
					page = 1;
					getdata(page);
				}
			});
			$('.input-group-btn .btn-default').click(function() {
				page = 1;
				getdata(page);
			});
			$('#js-addVersion').click(function() {
				if(isreplace) {
					$('.addfilebox').hide();
					$('.uploadfilebox').show();
				} else {
					$('.addfilebox select,.addfilebox input[type=file]').val('');
					$('.addfilebox').show();
					$('.uploadfilebox').hide();
				}
				$('#addModal').modal('show');
				$('.addfilebox').show();
				$('.uploadfilebox').hide();
			})
		})
		//获取信息
	function getdata(page) {
		var categoryId = $('#filterdeviceType').val();
		var isNew = $('#isNew').val();
		var publicTime = $('.time').val();
		var status = $('#status').val();
		var name = $('#searchKey').val();
		var param = {
			"categoryId": categoryId,
			"isNew": isNew,
			"name": name,
			"publicTime": publicTime,
			"status": status,
			"page": page,
			"pageSize": pageSize,
			"sessionKey": session.sessionKey,
			"sessionId": session.sessionId
		}
		console.log(JSON.stringify(param));
		$.ajax({

			type: 'post',
			url: service + "base_version/find",
			dataType: "json",
			data: param,
			success: function(data) {

				console.log(JSON.stringify(data));

				if(data.ret == 'ok') {
					var result = data.item;
					pagecount = Math.ceil(data.totalSize / pageSize);

					_TOTAL = pagecount;
					_NUM = data.page;
					pager(_NUM, _TOTAL);
					var str = "";
					if(result) {
						var str = "";
						for(var i = 0; i < result.length; i++) {

							str += '<tr data-id="' + result[i].id + '" data-ftp="' + result[i].baseFtpId + '"><td>' + (i + 1) + '</td><td data-category="' + result[i].categoryId + '">' + result[i].baseCategory.categoryName + '</td>' +
								' <td>' + result[i].prefix + '</td>' +
								' <td>' + result[i].protocolNumber + '</td>' +
								' <td>' + result[i].protocalShorthand + '</td>' +
								'  <td>' + result[i].filename + '</td>' +
								'  <td>' + result[i].publicTime + '</td>' +
								'  <td>' + result[i].status + '</td>' +
								'  <td>' + result[i].isNew + '</td>' +
								'  <td>' + result[i].remark + '</td>' +
								'  <td><a href="javascript:;"  onclick="editVersion(this)">编辑</a>' +
								' </td></tr>';
						}
						$('#verlist tbody').html(str);
						$(".total").text(data.totalSize);

					}
				}

			},
			error: function() {
				alert("发生错误");
			}
		});

	}

	function addVersion() {
		var deviceType = $('.deviceType').eq(0).val();
		var baseFtpId = $('.FTPType').eq(0).val();

		var param = new FormData();
		param.append('file', $('.file')[0].files[0]);
		param.append('categoryId', deviceType);
		param.append('baseFtpId', baseFtpId);
		param.append('sessionKey', session.sessionKey);
		param.append('sessionId', session.sessionId);
		if(isreplace) {
			param.append('isCover', '是');
		}
		console.log("参数" + JSON.stringify(param));
		$.ajax({

			type: 'post',
			url: service + "base_version/save",
			dataType: "json",
			data: param,
			processData: false,
			contentType: false,
			success: function(data) {

				console.log(JSON.stringify(data));
				var msg = $.zui.messager.show(data.reason, {
					placement: 'top',
					time: '1000'
				});
				//alert(JSON.stringify(data));
				if(data.ret == 'ok') {
					$("#addModal").modal("hide");
					$('#editId').val(data.item.id);
					$('#editname').val(data.item.filename);
					$('#editshortname').val(data.item.protocalShorthand);
					$('#editStatus').val(data.item.status); //状态
					$("#editNew").val(data.item.isNew); //是否最新
					$('#remark').val(data.item.remark);
					$('#editdeviceType').val(data.item.categoryId);
					$('#editFTPType').val(data.item.baseFtpId);
					$('#editModal .modal-body div').addClass('hidden');
					$('#editModal').modal('show');
				} else if(data.ret == 'fileDup') {
					isreplace = true;
					$('.addfilebox').hide();
					$('.uploadfilebox').show();
				}

			},
			error: function() {
				alert("发生错误");
			}
		});
	}

	function confirmDelBtn() {
		var id = $("#editId").val();
		var param = {
			"id": id,
			"sessionKey": session.sessionKey,
			"sessionId": session.sessionId
		}
		console.log(JSON.stringify(param));
		$.ajax({

			type: 'post',
			url: service + "base_version/delete",
			dataType: "json",
			data: param,
			success: function(data) {

				console.log(JSON.stringify(data));
				var msg = $.zui.messager.show(data.reason, {
					placement: 'top',
					time: '1000'
				});

				if(data.ret == 'ok') {
					$("#editModal").modal("hide");
					getdata();
				}

			},
			error: function() {
				alert("发生错误");
			}
		});
	}

	function editVersion(obj) {
		var $me = $(obj).parents("tr");
		$("#editId").val($me.attr("data-id"));
		$("#editname").val($me.find("td").eq(5).text()); //文件名
		$("#editshortname").val($me.find("td").eq(4).text()); //协议简称
		$('#editStatus').val($me.find("td").eq(7).text()); //状态
		$("#editNew").val($me.find("td").eq(8).text()); //是否最新
		$('#remark').val($me.find("td").eq(9).text());
		$('#editdeviceType').val($me.find("td").attr('data-category'));
		$('#editFTPType').val($me.attr("data-ftp"));
		$('#editModal .modal-body div').addClass('hidden');

		$("#editModal").modal("show");

	}

	function confirmedit() {
		var id = $('#editId').val();
		var isNew = $('#editNew').val();
		var remark = $('#remark').val();
		var status = $('#editStatus').val();

		if($('#editModal .modal-body div').hasClass('hidden')) {

			var param = {
				"id": id,
				"isNew": isNew,
				"remark": remark,
				"status": status,
				"sessionKey": session.sessionKey,
				"sessionId": session.sessionId
			}
			console.log(JSON.stringify(param));
			$.ajax({

				type: 'post',
				url: service + "base_version/modify",
				dataType: "json",
				data: param,

				success: function(data) {

					console.log(JSON.stringify(data));
					var msg = $.zui.messager.show(data.reason, {
						placement: 'top',
						time: '1000'
					});

					if(data.ret == 'ok') {
						$("#editModal").modal("hide");
						getdata();
					}

				},
				error: function() {
					alert("发生错误");
				}
			});
		} else {
			var deviceType = $('.deviceType').eq(1).val();
			var baseFtpId = $('.FTPType').eq(1).val();
			var param = new FormData();

			param.append('file', $('.uploadfile')[0].files[0]);
			param.append('categoryId', deviceType);
			param.append('baseFtpId', baseFtpId);
			param.append('isNew', isNew);
			param.append('remark', remark);
			param.append('status', status);
			param.append('id', id);
			param.append('sessionKey', session.sessionKey);
			param.append('sessionId', session.sessionId);
			console.log(JSON.stringify(param));
			$.ajax({

				type: 'post',
				url: service + "base_version/modify",
				dataType: "json",
				data: param,
				processData: false,
				contentType: false,
				success: function(data) {

					console.log(JSON.stringify(data));
					var msg = $.zui.messager.show(data.reason, {
						placement: 'top',
						time: '1000'
					});

					if(data.ret == 'ok') {
						$("#editModal").modal("hide");
						getdata();
					}

				},
				error: function() {
					alert("发生错误");
				}
			});
		}

	}
	/*获取设备版本类型*/
	function getDeviceType() {

		var param = {
			categoryType: '设备版本类型',
			sessionId: session.sessionId,
			sessionKey: session.sessionKey
		}
		console.log(JSON.stringify(param));
		$.ajax({

			type: 'post',
			url: service + "category/get_module_category",
			dataType: "json",
			data: param,
			success: function(data) {

				console.log("版本类型" + JSON.stringify(data));
				if(data.ret == 'ok') {
					var result = data.item;
					var type = '<option value="">全部</option>';
					var str = "";
					for(var i = 0; i < result.length; i++) {

						str += '<option value="' + result[i].id + '">' + result[i].categoryName + '</option>';
						type += '<option value="' + result[i].id + '">' + result[i].categoryName + '</option>';
					}
					$('.deviceType').html(str);
					$('#filterdeviceType').html(type);

				}

			},
			error: function() {
				alert("发生错误");
			}
		});

	}
	/**
	 * 获取ftp服务器
	 */
	function getFTP() {
		var param = {

				sessionId: session.sessionId,
				sessionKey: session.sessionKey
			}
			//console.log(JSON.stringify(param));
		$.ajax({

			type: 'post',
			url: service + "base_ftp/get_all",
			dataType: "json",
			data: param,
			success: function(data) {

				console.log(JSON.stringify(data));
				if(data.ret == 'ok') {
					var result = data.item;

					var str = "";
					for(var i = 0; i < result.length; i++) {

						str += '<option value="' + result[i].id + '">' + result[i].ftpName + '</option>';
					}
					$('.FTPType').html(str);

				}

			},
			error: function() {
				alert("发生错误");
			}
		});
	}
</script>