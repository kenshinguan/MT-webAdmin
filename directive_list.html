<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>问题</title>
    <link href="css/zui.css" rel="stylesheet" />
    <link href="css/chosen.css" rel="stylesheet" />
    <link href="css/datetimepicker.css" rel="stylesheet" />
    <link href="lib/datatable/zui.datatable.min.css" rel="stylesheet" />
    <link href="css/common.css" rel="stylesheet" />
    <link href="css/page.css" rel="stylesheet" />
    <script src="js/jquery-1.9.1.min.js"></script>
    <script src="js/zui.js"></script>
    <script src="js/chosen.js"></script>
    <script src="js/datetimepicker.js"></script>
    <script src="lib/datatable/zui.datatable.min.js"></script>
    <script src="js/common.js"></script>
</head>
<style type="text/css">
    .searchbar input[type=text][readonly=readonly] {
        background: #fff;
        width: 200px;
    }
</style>

<body class="minwidth1080">
    <div class="head">
      
        <ol class="breadcrumb">
            <li><a href="your/url/"><i class="icon icon-home"></i>当前位置</a></li>
            <li><a href="your/url/">查询</a></li>
            <li class="active">指令查询</li>
        </ol>
        <div class="row operationbar">
            <div class="col-md-7">
            </div>
            <div class="col-md-5">
                <div class="input-group">
                    <span class="input-group-addon"><i class="icon-search"></i></span>
                    <input type="text" class="form-control" id="searchKey">
                    <span class="input-group-addon input-remove"><i class="icon-remove-circle"></i></span>
                    <span class="input-group-btn">
                        <button class="btn btn-default" type="button">搜索</button>
                    </span>
                </div>
                <div class="search-group hidden" id='searchlist'>
                    <div class="list-group">
                        <a href="#" class="list-group-item active" data-type="equipmentName">
                            在名称中查找：
                            <span></span> 
                        </a>
                        <a href="#" class="list-group-item" data-type="equipmentMid">
                            在mid中查找：
                            <span></span>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="searchbar">    
                <label class="ml10">指令</label>
                <select class="form-control" id="directive">


                </select>
                <label class="ml10">扩展
                </label>
                <select class="form-control" id="extend" disabled="true">

                </select>
                <label class="ml10">状态</label>
                <select class="form-control" id="directiveType">
                    <option value="">全部</option>
                    <option value="0">未获取</option>
                    <option value="1">未执行</option>
                    <option value="2">已执行</option>
                </select>
                <label class="ml10">日期</label>
                <input type="text" class="form-control" readonly="readonly" id="date" />
                <label class="ml10">时间</label>
                <input type="text" class="form-control" readonly="readonly" id="startTime" />
                    -
                <input type="text" class="form-control" readonly="readonly" id="endTime" />                  
        </div>
    </div>
    <div class="main">
        <table class="table table-striped table-bordered cardTable table-datatable datatable" style="width: 100%;table-layout:fixed;">
            <thead>
                <tr>
                    <th style="width: 7%">序号</th>
                    <th style="width: 15%">MID</th>
                    <th style="width: 10%">名称</th>
                    <th style="width: 10%">指令</th>
                    <th style="width: 20%">扩展</th>
                    <th style="width: 10%">状态</th>
                    <th style="width: 20%">创建时间</th>
                </tr>
            </thead>
            <tbody>
            </tbody>


        </table>
    </div>
    <div class="footer row">
        <div class="col-md-8 leftpage">
            <span class="ml10">总计：<span class="total">82</span>条</span>
            <label class="ml40">显示</label>
            <select class="form-control" id="pageSize">
                <!--<option value="10">10</option>
                <option value="20">20</option>-->
                <option value="50">50</option>
                <option value="100">100</option>
            </select>
            <label>行</label>
        </div>
        <div class="text-right col-md-4">
            <ul class="pager ">

            </ul>
            <input type="text" id="numtxt" />
            <input type="submit" value="跳转" class="btn" id="gotopage" />
        </div>
    </div>

</body>

</html>
<script>
    //初始化数据表
    var page = 1, pageSize = 50, pagecount = 0;
    //指令集
    var commandList = [], externList = [], commandNewList = [], externNewList = [], commandExternList = [];
    $(function () {
        $('#searchlist .list-group a').click(function () {
            $('#searchlist .list-group a.active').removeClass('active');
            $(this).addClass('active');
        });
        $('.input-group-btn .btn-default').click(function() {
            page = 1;
            getdata(page);
        });
        $('#date').selecDay();
        $('#startTime').selectime();
        $('#endTime').selectime();

        searchkey();

        getcommand();

    });

    //页面大小选择
    $("#pageSize").bind("change",function(){ 
        if($(this).val() == 0) {
            return; 
        } else {
            pageSize = $(this).val();
            page = 1;
            getdata(page);
        } 
    });

    $('#directive').bind("change", function () {
        var directive = $('#directive').val();
        if (directive) {
            var param = {
                "command": directive,
                "sessionKey": session.sessionKey,
                "sessionId": session.sessionId
            }
            // console.log(JSON.stringify(param));
            
            $.ajax({
                type: 'post',
                url: service + "msgcommand/findbycommand",
                dataType: "json",
                data: param,
                success: function (data) {
                    // console.log(JSON.stringify(data));

                    if (data.ret == 'ok') {
                        var result = data.item;
                        var extern_str = '<option value="">全部</option>';
                        if (result) {
                            for (var i = 0; i < result.length; i++) {
                                if (directive == "version") {
                                    extern_str += '<option value=' + result[i] + '>' + JSON.parse(result[i]).tertype + '</option>';
                                } else {
                                    extern_str += '<option value=' + result[i] + '>' + result[i] + '</option>';
                                }
                            }
                            $('#extend').html(extern_str);
                            $('#extend').attr("disabled", false);
                        }
                    }
                },
                error: function () {
                    alert("发生错误");
                }
            });
        } else {
            var extern_str = '';
            $('#extend').html(extern_str);
            $('#extend').attr("disabled", true);
         }
    });

    //测试
    // $('#directive').bind("change", function () {
    // 	var directive = $('#directive').val();
    // 	if (directive) {
    //         for (var i = 0;i < commandExternList.length; i++) {
    //             if (directive == commandExternList[i].command) {
    //                 var extern_str = '';
    //                 for (var j = 0; j < commandExternList[i].extern.length; j++) {
    //                   extern_str += '<option value="' + commandExternList[i].extern[j] + '">' + commandExternList[i].extern[j] + '</option>';
    //                 }
    //             }
    //         }
    // 		$('#extend').html(extern_str);
    // 		$('#extend').attr("disabled", false);
    // 	} else {
    //         var extern_str = '';
    //         $('#extend').html(extern_str);
    // 		$('#extend').attr("disabled", true);
    // 	}
    // });

    function getdata(page) {
        var date = $('#date').val();
        var startTime = $('#startTime').val();
        var endTime = $('#endTime').val();

        if (date) {
            if (startTime == '' || endTime == '') {
                var msg = $.zui.messager.show('检索时间段不完整', {
                    placement: 'top',
                    time: '1000'
                });
                return;                
            };
        }
        if (startTime) {
            if (date == '' || endTime == '') {
                var msg = $.zui.messager.show('检索时间段不完整', {
                    placement: 'top',
                    time: '1000'
                });
                return;                
            };
        }
        if (endTime) {
            if (date == '' || startTime == '') {
                var msg = $.zui.messager.show('检索时间段不完整', {
                    placement: 'top',
                    time: '1000'
                });
                return;                
            };
        }
        if (date && startTime && endTime) {
            var startTime_h = parseInt(startTime.split(":")[0]);
            var startTime_m = parseInt(startTime.split(":")[1]);
            var endTime_h = parseInt(endTime.split(":")[0]);
            var endTime_m = parseInt(endTime.split(":")[1]);
            if (startTime_h > endTime_h) {
                var msg = $.zui.messager.show('开始时间要晚于结束时间', {
                    placement: 'top',
                    time: '1000'
                });
                return;
            } 
            if (startTime_h == endTime_h) {
                if (startTime_m >= endTime_m) {
                    var msg = $.zui.messager.show('开始时间要晚于结束时间', {
                        placement: 'top',
                        time: '1000'
                    });
                    return;
                }
            }

        }

        var command = $('#directive').val();

        if (command) {
            var extend = $('#extend').val();
        } else {
            var extend = '';
        }

        var status = $('#directiveType').val();

        var deviceName = '';
        var mid = '';
        var type = $('#searchlist .list-group-item.active').attr('data-type');
        if(type == 'equipmentName') {
            deviceName = $('#searchKey').val();
        } else if (type == 'equipmentMid') {
            mid = $('#searchKey').val();
        }

        var param = {
            "date": date,
            "startTime": startTime,
            "endTime": endTime,
            "deviceName": deviceName,
            "mid": mid,
            "command": command,
            "extern": extend,
            "status": status,
            "page": page,   
            "pageSize": pageSize,
            "sessionKey": session.sessionKey,
            "sessionId": session.sessionId
        }
        console.log(JSON.stringify(param));
        
        $.ajax({
            type: 'post',
            url: service + "msgcommand/queryStatues",
            dataType: "json",
            data: param,
            success: function (data) {
                   console.log(JSON.stringify(data));
                if (data.ret == 'ok') {
                    var result = data.item;
                    pagecount = Math.ceil(data.totalSize / pageSize);

                    _TOTAL = pagecount;
                    _NUM = data.page;
                    pager(_NUM, _TOTAL);
                    var str = "";
                    if (result) {
                        for (var i = 0; i < result.length; i++) {
                            var status = '';
                            if (result[i].status == 0) {
                                status = '未获取';
                            } else if (result[i].status == 1) {
                                status = '未执行';
                            } else if (result[i].status == 2) {
                                status = '已执行';
                            }
                            str += ' <tr data-id="' + result[i].id + '"> <td>' + ((page-1)*pageSize+(i+1)) + '</td><td>' + result[i].mid + '</td><td>' + result[i].deviceName +'</td><td>' + result[i].command + '</td><td style="word-wrap:break-word;">' + result[i].extern + '</td><td>' + status + '</td><td>' + result[i].time + '</td></tr>';
                        }

                        $('.main table tbody').html(str);
                        $(".total").text(data.totalSize);

                    } else {
                        $('.main table tbody').html(str);
                    }
                }



            },
            error: function () {
                alert("发生错误");
            }
        });
    }

    function getcommand() {
        var param = {
            "command": "",
            "sessionKey": session.sessionKey,
            "sessionId": session.sessionId
        }
        // console.log(JSON.stringify(param));
        
        $.ajax({
            type: 'post',
            url: service + "msgcommand/findbycommand",
            dataType: "json",
            data: param,
            success: function (data) {
                // console.log(JSON.stringify(data));

                if (data.ret == 'ok') {
                    var result = data.item;
                    var command_str = '<option value="">全部</option>';
                    if (result) {
                        for (var i = 0; i < result.length; i++) {
                            command_str += '<option value=' + result[i] + '>' + result[i] + '</option>';
                        }
                        $('#directive').html(command_str);
                        $("#directive").chosen({
                            no_results_text: '没有找到',
                            search_contains: true
                        });
                    }

                    getdata(page);
                    
                }
            },
            error: function () {
                alert("发生错误");
            }
        });
    }

    // function getcommand() {
    //     var param = {
    //         "date": "",
    //         "startTime": "",
    //         "endTime": "",
    //         "deviceName": "",
    //         "mid": "",
    //         "command": "",
    //         "extern": "",
    //         "status": "",
    //         "page": "",   
    //         "pageSize": "",
    //         "sessionKey": session.sessionKey,
    //         "sessionId": session.sessionId
    //     }
    //     console.log(JSON.stringify(param));
        
    //     $.ajax({
    //         type: 'post',
    //         url: service + "msgcommand/queryStatues",
    //         dataType: "json",
    //         data: param,
    //         success: function (data) {
    //             console.log(JSON.stringify(data));
    //             if (data.ret == 'ok') {
    //                 if (data.item) {
    //                     for (var i = 0; i < data.item.length; i++) {
    //                         commandList.push(data.item[i].command);
    //                     }
    //                 }
    //             }
    //             commandExtern(data.item);
    //         },
    //         error: function () {
    //             alert("发生错误");
    //         }
    //     });
    // }

    // function commandExtern(data) {
    //     commandNewList = uniqueArray(commandList);
    //     for (var i = 0; i < commandNewList.length; i++) {
    //         for (var j = 0; j < data.length; j++) { 
    //             if (commandNewList[i] == data[j].command) {
    //                 externList.push(data[j].extern);
    //             }
    //         }
    //         commandExternList.push({
    //             command: commandNewList[i],
    //             extern: uniqueArray(externList)
    //         });
    //         externList = [];
    //     }
    //     // console.log(JSON.stringify(commandExternList));

    //     var command_str = '<option value="">全部</option>';
    //     for (var i = 0; i < commandExternList.length; i++) {
    //         command_str += '<option value="' + commandExternList[i].command + '">' + commandExternList[i].command + '</option>';
    //     }
    //     $('#directive').html(command_str);
    //     $("#directive").chosen({
    //         no_results_text: '没有找到',
    //         search_contains: true
    //     });
    // }

    // function uniqueArray(data){  
    //     data = data || [];  
    //     var a = {};  
    //     for (var i=0; i<data.length; i++) {  
    //         var v = data[i];  
    //         if (typeof(a[v]) == 'undefined'){  
    //             a[v] = 1;  
    //         }  
    //     }  
    //     data.length=0;  
    //     for (var i in a) {  
    //         data[data.length] = i;  
    //     }  
    //     return data;  
    // }
</script>
