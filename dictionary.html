<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="UTF-8">
		<title>字典</title>

		<link href="css/zui.css" rel="stylesheet" />
		<link href="css/chosen.css" rel="stylesheet" />

		<link href="css/common.css" rel="stylesheet" />
		<link href="css/page.css" rel="stylesheet" />
		<script src="js/jquery-1.9.1.min.js"></script>
		<script src="js/zui.js"></script>
		<script src="js/chosen.js"></script>

		<script src="js/common.js"></script>
		<style type="text/css">
			.chosen-container {
				width: 200px !important;
			}
		</style>

	</head>

	<body class="minwidth1080">
		<div class="head">
			<div class="modal fade" id="setMarkmodal">
				<div class="modal-dialog  modal-sm">
					<div class="modal-content">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">关闭</span></button>
							<h4 class="modal-title">确定</h4>
						</div>
						<div class="modal-body">
							<input type="hidden" class="MarkId" />
							<p>你确定设置为维护组吗？</p>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-primary" onclick="setMarkBtn()">确定</button>
							<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
						</div>
					</div>
				</div>
			</div>
			<div class="modal fade" id="cancelMarkmodal">
				<div class="modal-dialog  modal-sm">
					<div class="modal-content">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">关闭</span></button>
							<h4 class="modal-title">确定</h4>
						</div>
						<div class="modal-body">
							<input type="hidden" class="MarkId" />
							<p>你确定取消为维护组吗？</p>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-primary" onclick="cancelMarkBtn()">确定</button>
							<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
						</div>
					</div>
				</div>
			</div>
			<div class="modal fade" id="confirmModal">
				<div class="modal-dialog  modal-sm">
					<div class="modal-content">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">关闭</span></button>
							<h4 class="modal-title">确定</h4>
						</div>
						<div class="modal-body">
							<input type="hidden" id="confirmDelId" />
							<input type="hidden" name="deltabId" id="deltabId" value="" />
							<p>你确定删除吗？</p>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-primary" onclick="confirmDelBtn()">确定</button>
							<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
						</div>
					</div>
				</div>
			</div>
			<div class="modal fade addModal" id="addGroup">
				<div class="modal-dialog ">
					<div class="modal-content">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">关闭</span></button>
							<h4 class="modal-title">新建</h4>
						</div>
						<div class="modal-body">
							<form method="" action="" class="modal-form">
								<input type="hidden" value id="userID" />

								<p>
									<label for="">上级标签</label>
									<select id="depart" class="chosen-select form-control">
									</select>

								</p>
								<p>
									<label for="">名称</label>
									<input type="text" id="labelName">
								</p>
								<p>
									<label for="">描述</label>
									<input type="text" id="describer" />
								</p>
								<p style="color: #f00;">*新建附件类型的时候，需要输入描述，及为附件类型的英文名称</p>
							</form>
						</div>
						<div class="modal-footer text-center">
							<button type="button" class="btn btn-primary" id="addlabelBtn">确定</button>
							<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
						</div>
					</div>
				</div>
			</div>
			<div class="modal fade addModal" id="editmodal">
				<div class="modal-dialog ">
					<div class="modal-content">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">关闭</span></button>
							<h4 class="modal-title">编辑</h4>
						</div>
						<div class="modal-body">
							<form method="" action="" class="modal-form">
								<input type="hidden" value id="editId" />
								<input type="hidden" name="" id="tabId" value="" />
								<p>
									<label for="">名称</label>
									<input type="text" id="editName">
								</p>
								<p>
									<label for="">描述</label>
									<input type="text" id="editdescriber" />
								</p>
							</form>
						</div>
						<div class="modal-footer text-center">
							<button type="button" class="btn btn-primary" onclick="confirmEditBtn()">确定</button>
							<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
						</div>
					</div>
				</div>
			</div>
			<ol class="breadcrumb">
				<li>
					<a href="your/url/"><i class="icon icon-home"></i>当前位置</a>
				</li>
				<li>
					<a href="your/url/">设置</a>
				</li>
				<li class="active">字典</li>
			</ol>
			<div class="row operationbar">
				<div class="col-md-7">
					<button class="btn btn-primary" type="button" id="js-addGroup">新增</button>

				</div>
				<div class="col-md-5">
					<div class="input-group">
						<span class="input-group-addon"><i class="icon-search"></i></span>
						<input type="text" class="form-control">

						<span class="input-group-btn">
                        <button class="btn btn-default" type="button">搜索</button>
                    </span>
					</div>

				</div>
			</div>

		</div>
		<div class="main">
			<div class='cols-wrap mt20'>
				<div class="cols-main" style="width: 100%;">
					<table class="table table-striped table-bordered cardTable table-datatable" style="display: none">
					</table>
				</div>
				<div class="cols-aside submenu" style="position: absolute; left: 10px; margin-left: 0; bottom: 0; top: 88px; overflow: auto">
					<div class="hd">字典选项</div>
					<ul class="bd ">

						<!--<li class="open">
							<a href="javascript:;"><i></i>公共</a>
							<ul>
								<li>
									<a href="javascript:;">模块一</a>
								</li>
								<li>
									<a href="javascript:;">模块二</a>
								</li>
							</ul>
						</li>

						<li class="open">
							<a href="javascript:;"><i></i>项目</a>
							<ul>
								<li>
									<a href="javascript:;">模块一</a>
								</li>
								<li>
									<a href="javascript:;">模块二</a>
								</li>
							</ul>
						</li>-->
					</ul>
				</div>
			</div>

		</div>

	</body>

</html>
<script>
	var select = [],
		isContact = false;

	$(function() {

		$('.submenu ').on("click", ".bd> li>a i", function() {
			if($(this).parents('li').hasClass('open')) {
				$(this).parents('li').removeClass('open');
			} else {
				$('.submenu .bd> li.open').removeClass('open')
				$(this).parents('li').addClass('open');
			}
		})
		$(".submenu").on("click", "a ", function() {
			$(".submenu a.active").removeClass("active")
			$(this).addClass("active");
			var $me = "table" + $(this).attr("data-id");
			if($(this).text() === '联系人') {
				isContact = true;
			} else {
				isContact = false;
			}
			$("#" + $me).show().siblings("table").hide();
		})
		$(".cols-main").on('click', '.editBtn', function() {
			var $me = $(this).parents("tr");

			$("#editName").val($me.find("td").eq(2).text());
			$("#editdescriber").val($me.find("td").eq(3).text());
			$("#editId").val($me.attr("data-id"));
			$('#tabId').val($me.parents('table').attr('id'));
			$("#editmodal").modal("show");
		})
		$(".cols-main").on('click', '.delBtn', function() {
				var $me = $(this).parents("tr");
				$("#confirmDelId").val($me.attr("data-id"));
				$('#deltabId').val($me.parents('table').attr('id'));
				$("#confirmModal").modal("show");
			})
			//设置维护组
		$(".cols-main").on('click', '.setMark', function() {
				var $mark = $(this).text();
				$(".MarkId").val($(this).parents("tr").attr("data-id"));
				//$("#confirmDelId").val($me.attr("data-id"));
				if(isContact) {
					if($mark == '维护组') {
						$("#cancelMarkmodal").modal("show");
					} else {
						$("#setMarkmodal").modal("show");
					}
				}
			})
			/*新增分类*/
		$('#js-addGroup').click(function() {
			$('#addGroup input[type=text]').val('');
			$('#addGroup select').val('');
			$('#addGroup').modal('show');
			$('#depart').trigger('chosen:updated');
		})
		getdata();
	})

	function getdata() {
		var param = {
			"sessionKey": session.sessionKey,
			"sessionId": session.sessionId
		}
		$.ajax({

			type: 'post',
			url: service + "category/find_all",
			dataType: "json",
			data: param,
			async: false,
			success: function(data) {

				console.log(JSON.stringify(data));
				if(data.ret == 'ok') {
					var item = data.item;
					var str = '';
					for(var i = 0; i < item.length; i++) {
						var piditem = {
							labelName: item[i].categoryName,
							pid: item[i].id
						};
						select.push(piditem);
						str += ' <li><a href="javascript:;"  data-id="' + item[i].id + '"><i></i>' + item[i].categoryName + '</a> <ul>';
						var tablestr2 = '<table id="table' + item[i].id + '"  class="table table-striped table-bordered cardTable table-datatable table-hover"><tr><th style="width:40px">' +
							'<input type="checkbox" name="" id="" value="" /></th>' +
							'  <th style="width:100px">序列1</th>' +
							' <th style="width:100px">名称</th>' +

							' <th style="width:200px">描述</th>' +
							' <th style="width:200px">备注</th>' +
							' <th  style="width:140px">操作</th> </tr>';

						if(item[i].sub) {
							for(var j = 0; j < item[i].sub.length; j++) {
								var subitem = {
									labelName: item[i].sub[j].categoryName,
									pid: item[i].sub[j].id
								};
								select.push(subitem);
								str += ' <li ><a href="javascript:;" data-id="' + item[i].sub[j].id + '">' + item[i].sub[j].categoryName + '</a></li>';
								tablestr2 += ' <tr data-id="' + item[i].sub[j].id + '"><td><input type="checkbox" name="" id="" value="" /></td><td>' + (j + 1) + '</td><td>' + item[i].sub[j].categoryName + '</td>' +
									'<td><a href="javascript:void(0)" >' + item[i].sub[j].describer + '</a></td><td><a href="javascript:void(0)"  class="setMark">' + item[i].sub[j].mark + '</a></td><td><a href="javascript:void(0)" class="editBtn">编辑</a><a href="javascript:void(0)" class="delBtn">删除</a></td></tr>';

								if(item[i].sub[j].sub) {
									var tablestr = '<table id="table' + item[i].sub[j].id + '"  class="table table-striped table-bordered cardTable table-datatable table-hover"><tr><th style="width:40px">' +
										'<input type="checkbox" name="" id="" value="" /></th>' +
										'  <th style="width:100px">序列</th>' +
										' <th style="width:220px">名称</th>' +

										' <th style="width:300px">描述</th>' +
										' <th style="width:300px">备注</th>' +
										' <th  style="width:160px">操作</th> </tr>';
									for(var h = 0; h < item[i].sub[j].sub.length; h++) {
										tablestr += ' <tr data-id="' + item[i].sub[j].sub[h].id + '"><td><input type="checkbox" name="" id="" value="" /></td><td>' + (h + 1) + '</td><td>' + item[i].sub[j].sub[h].categoryName + '</td>' +
											'<td><a href="javascript:void(0)" >' + item[i].sub[j].sub[h].describer + '</a></td><td><a href="javascript:void(0)"  class="setMark">' + item[i].sub[j].sub[h].mark + '</a></td><td><a href="javascript:void(0)" class="editBtn">编辑</a><a href="javascript:void(0)" class="delBtn">删除</a></td></tr>';
									}
									$(".cols-main").append(tablestr + '</table>');
									//  $(".cols-main table").eq(1).show().siblings("table").hide();
								}

							}

						}
						str += '</ul></li>';
						$(".submenu ul.bd").html(str);
						$(".cols-main").append(tablestr2 + '</table>');
						var obj = ".cols-main table#table" + item[0].id;

						$(obj).show().siblings("table").hide();
					}
				}

				var depart = '';
				for(var i = 0; i < select.length; i++) {
					depart += ' <option value="' + select[i].pid + '">' + select[i].labelName + '</option>'
				}
				$("#depart").html(depart);
				$("#depart").chosen();
			},
			error: function() {
				alert("发生错误");
			}
		});

	};
	$("#addlabelBtn").click(function() {
			if(!$("#labelName").val()) {
				alert("请输入标签名称");
				return false;
			}
			var depart = $("#depart").val();
			var param = {
					"pid": $("#depart").val(),
					"operater": operater,
					"categoryName": $("#labelName").val(),
					"describer": $("#describer").val(),
					"sessionKey": session.sessionKey,
					"sessionId": session.sessionId
				}
				//alert(JSON.stringify(param));
			$.ajax({

				type: 'post',
				url: service + "category/save_category",
				dataType: "json",
				data: param,
				success: function(data) {

					console.log(JSON.stringify(data));
					$.zui.messager.show(data.reason, {
						placement: 'top',
						time: '1000'
					});
					if(data.ret == 'ok') {
						$("#addGroup").modal("hide");
						$(".cols-main").html("");
						$(".submenu ul.bd").html("");
						select = [];
						getdata();
						var str = '.submenu ul li a[data-id=' + depart + ']';

						$(str).click();

					}

				},
				error: function() {
					alert("发生错误");
				}
			});
		})
		//确认编辑
	function confirmEditBtn() {
		var labelName = $("#editName").val();
		if(!labelName) {
			alert("请输入名称");
			return false;
		}
		var labelId = $("#editId").val();
		var tabId = $("#tabId").val();

		var param = {
				id: labelId,
				"operater": operater,
				"categoryName": labelName,
				"describer": $("#editdescriber").val(),
				"sessionKey": session.sessionKey,
				"sessionId": session.sessionId
			}
			//  alert(JSON.stringify(param));
		$.ajax({

			type: 'post',
			url: service + "category/modify",
			dataType: "json",
			data: param,
			success: function(data) {

				console.log(JSON.stringify(data));
				$.zui.messager.show(data.reason, {
					placement: 'top',
					time: '1000'
				});
				if(data.ret == 'ok') {
					$("#editmodal").modal("hide");
					$(".cols-main").html("");
					$(".submenu ul.bd").html("");
					select = [];
					getdata();

					var dataId = tabId.substring(5, tabId.length);
					var str = '.submenu ul li a[data-id=' + dataId + ']';

					$(str).click();
				}

			},
			error: function() {
				alert("发生错误");
			}
		});
	}
	//删除
	function confirmDelBtn() {
		var labelId = $("#confirmDelId").val();
		var tabId = $("#deltabId").val();
		var param = {
			id: labelId,
			"operater": operater,
			"sessionKey": session.sessionKey,
			"sessionId": session.sessionId
		}
		console.log("删除" + JSON.stringify(param));
		$.ajax({

			type: 'post',
			url: service + "category/delete_category",
			dataType: "json",
			data: param,
			success: function(data) {

				console.log(JSON.stringify(data));
				$.zui.messager.show(data.reason, {
					placement: 'top',
					time: '1000'
				});
				if(data.ret == 'ok') {
					$("#confirmModal").modal("hide");
					$(".cols-main").html("");
					$(".submenu ul.bd").html("");
					select = [];
					getdata();
					var dataId = tabId.substring(5, tabId.length);
					var str = '.submenu ul li a[data-id=' + dataId + ']';
					$(str).click();
				}

			},
			error: function() {
				alert("发生错误");
			}
		});
	}

	function setMarkBtn() {
		var markId = $(".markId").val();
		var param = {
				id: markId,
				"operater": operater,
				"sessionKey": session.sessionKey,
				"sessionId": session.sessionId
			}
			// alert(JSON.stringify(param));
		$.ajax({

			type: 'post',
			url: service + "category/set_contact_mark",
			dataType: "json",
			data: param,
			success: function(data) {

				console.log(JSON.stringify(data));
				$.zui.messager.show(data.reason, {
					placement: 'top',
					time: '1000'
				});
				if(data.ret == 'OK') {
					$("#setMarkmodal").modal("hide");
					$(".cols-main").html("");
					$(".submenu ul.bd").html("");
					select = [];
					getdata();
				}

			},
			error: function() {
				alert("发生错误");
			}
		});
	}

	function cancelMarkBtn() {
		var markId = $(".markId").val();
		var param = {
				id: markId,
				"operater": operater,
				"sessionKey": session.sessionKey,
				"sessionId": session.sessionId
			}
			// alert(JSON.stringify(param));
		$.ajax({

			type: 'post',
			url: service + "category/cancel_contact_mark",
			dataType: "json",
			data: param,
			success: function(data) {

				console.log(JSON.stringify(data));
				$.zui.messager.show(data.reason, {
					placement: 'top',
					time: '1000'
				});
				if(data.ret == 'OK') {
					$("#cancelMarkmodal").modal("hide");
					$(".cols-main").html("");
					$(".submenu ul.bd").html("");
					select = [];
					getdata();
				}

			},
			error: function() {
				alert("发生错误");
			}
		});
	}
</script>